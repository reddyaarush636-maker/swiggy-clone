name: DOCKER Pipeline

on:
  push:
    branches:
      - main

env:
  APP_PORT: 3000
  IMAGE_NAME: rahamshaik/gabrimage
  CONTAINER_NAME: gabr1_app

jobs:
  job-1:
    runs-on: ubuntu-latest

    steps:

      # 1Ô∏è‚É£ Checkout
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è‚É£ Install Dependencies
      - name: Install Dependencies
        run: npm  install

      # 4Ô∏è‚É£ Clean
      - name: Clean Old Build
        run: rm -rf dist || true

      # 5Ô∏è‚É£ Build
      - name: Build Application
        run: npm run build

      # 6Ô∏è‚É£ Test
      - name: Run Tests
        run: npm test

      # 7Ô∏è‚É£ Build Docker Image
      - name: Build Docker Image
        run: docker build -t $IMAGE_NAME:${{ github.sha }} .

      # 8Ô∏è‚É£ Tag Image for DockerHub
      - name: Tag Image
        run: docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:latest

      # 9Ô∏è‚É£ Login to DockerHub
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # üîü Push Image
      - name: Push Docker Image
        run: |
          docker push $IMAGE_NAME:${{ github.sha }}
          docker push $IMAGE_NAME:latest
